

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vector initialization example #1 &mdash; sycl-examples  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/main_stylesheet.css?v=a6d91ecf" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Vector initialization example #2" href="vector-init-refactored.html" />
    <link rel="prev" title="Device discovery example" href="device-discovery.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            sycl-examples
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="device-discovery.html">Device discovery example</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Vector initialization example #1</a></li>
<li class="toctree-l1"><a class="reference internal" href="vector-init-refactored.html">Vector initialization example #2</a></li>
<li class="toctree-l1"><a class="reference internal" href="vector-add.html">Vector addition example</a></li>
<li class="toctree-l1"><a class="reference internal" href="vector-reduce.html">Vector reduction example</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">sycl-examples</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Vector initialization example #1</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/vector-init.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="toctree-wrapper compound" id="vector-init">
</div>
<section id="vector-initialization-example-1">
<h1>Vector initialization example #1<a class="headerlink" href="#vector-initialization-example-1" title="Link to this heading">ÔÉÅ</a></h1>
<p>This example is based on the <cite>Anatomy of a SYCL application</cite> found in
<span id="id1">[<a class="reference internal" href="index.html#id12" title="The Khronos SYCL Working Group. Sycl specification version 2020. 2020. Accessed: Oct 21, 2024. URL: https://registry.khronos.org/SYCL/specs/sycl-2020/html/sycl-2020.html.">TheKSWGroup20</a>]</span> specification.
Some of the information related to memory management in SYCL are from
<span id="id2">[<a class="reference internal" href="index.html#id16" title="ENCCS. Sycl workshop: buffers and accessors. 2021. Accessed: Oct 22, 2024. URL: https://enccs.github.io/sycl-workshop/buffers-accessors/.">ENC21</a>]</span> and <span id="id3">[<a class="reference internal" href="index.html#id17" title="Codeplay Software. Memory model - computecpp ce 2.11.0. Accessed: Oct 22, 2024. URL: https://developer.codeplay.com/products/computecpp/ce/2.11.0/guides/sycl-for-cuda-developers/memory-model.">Sof</a>]</span>.</p>
<div class="docutils container">
<dd><p>This example illustrates how to run a simple vector initialization kernel on a SYCL device using the SYCL API. Full source code of the example is shown below: <div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cassert&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/sycl.hpp&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">sycl</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>

<span class="w">  </span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buf_v</span><span class="p">{</span><span class="n">v</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">range</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()}};</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">command_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">accessor</span><span class="w"> </span><span class="n">acc</span><span class="p">{</span><span class="n">buf_v</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">write_only</span><span class="p">,</span><span class="w"> </span><span class="n">no_init</span><span class="p">};</span>
<span class="w">    </span><span class="n">h</span><span class="p">.</span><span class="n">parallel_for</span><span class="p">(</span><span class="n">range</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()},</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="n">id</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">acc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="n">queue</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>

<span class="w">  </span><span class="n">q</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">command_group</span><span class="p">);</span>
<span class="w">  </span><span class="n">q</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>

<span class="w">  </span><span class="n">host_accessor</span><span class="w"> </span><span class="n">acc</span><span class="p">{</span><span class="n">buf_v</span><span class="p">,</span><span class="w"> </span><span class="n">read_only</span><span class="p">};</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">assert</span><span class="p">(</span><span class="n">acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Wrong value in v!&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</p>
<p>We start by first creating a <code class="docutils literal notranslate"><span class="pre">std::vector</span></code> named <code class="docutils literal notranslate"><span class="pre">v</span></code> on the host with uninitialized values: <div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
</pre></div>
</div>
</p>
<p>Since we are initializing a vector using a SYCL kernel, we need to manage memory on both the host and the device (including transfers between the two where necessary). There are three different abstractions to perform memory managements in SYCL:<ul class="simple">
<li><p>unified shared memory</p></li>
<li><p>buffer and accessor API</p></li>
<li><p>images</p></li>
</ul>
</p>
<p>In this example, we will use SYCL buffers and accessors for memory management. Buffers provide views into already allocated memory and they do not own the memory they are associated with. The memory associated with a buffer is accessed using an accessor which is created based on the data access need (e.g., read-only, write-only, etc.). Only trivially copyable objects (like scalars, arrays of scalars, etc.) can be represented using buffers. We create a SYCL buffer associated with vector <code class="docutils literal notranslate"><span class="pre">v</span></code> using the statement shown below. In this case, we provide the host data pointer and a <code class="docutils literal notranslate"><span class="pre">sycl::range</span></code> that defines the valid range of the data during the construction of the buffer. <div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buf_v</span><span class="p">{</span><span class="n">v</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">range</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()}};</span>
</pre></div>
</div>
</p>
<p>Next we are going to create the command group which encompasses our SYCL kernel. A SYCL command group is a function object which takes a reference to a <code class="docutils literal notranslate"><span class="pre">sycl::handler</span></code> object and callable with the <code class="docutils literal notranslate"><span class="pre">operator()</span></code>. In this case, we define the function as a lambda so it is able to capture the variables from the surrounding scope by reference. <div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">command_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">accessor</span><span class="w"> </span><span class="n">acc</span><span class="p">{</span><span class="n">buf_v</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">write_only</span><span class="p">,</span><span class="w"> </span><span class="n">no_init</span><span class="p">};</span>
<span class="w">  </span><span class="n">h</span><span class="p">.</span><span class="n">parallel_for</span><span class="p">(</span><span class="n">range</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()},</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="n">id</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">acc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"> </span><span class="p">});</span>
<span class="p">};</span>
</pre></div>
</div>
</p>
<p>In the body of the command group, we create an accessor to our buffer object. Note that this is a device accessor as it is part of a command group. We pass two properties to let SYCL know that it is for write only and the initialization is not required. The actual SYCL kernel for vector initialization is then passed into the <code class="docutils literal notranslate"><span class="pre">parallel_for()</span></code> function of the command group handler. First argument to <code class="docutils literal notranslate"><span class="pre">parallel_for()</span></code> is a <code class="docutils literal notranslate"><span class="pre">sycl::range</span></code> which defines the execution range of the kernel. In this case, our execution range is equal to the number of elements in the array. The second argument is a lambda function which implements the kernel logic. This lambda function is executed for each member in the range and the member value is passed in by the <code class="docutils literal notranslate"><span class="pre">idx</span></code>. In this, we initialize the vector by setting all the elements equal to 42.</p>
<p>Next we create a SYCL queue to execute the SYCL command group on a SYCL device. Since we don‚Äôt provide any arguments to the constructor of the SYCL queue object, it will use the default device in the default platform to execute the command groups. <div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">queue</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
</pre></div>
</div>
</p>
<p>Once the queue is created, we can submit our command group by using the <code class="docutils literal notranslate"><span class="pre">submit()</span></code> function. <div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">q</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">command_group</span><span class="p">);</span>
</pre></div>
</div>
 The SYCL runtime executes all the submitted command groups asynchronously. So, we need to call the <code class="docutils literal notranslate"><span class="pre">wait()</span></code> function on the queue in order to make sure that the our command group finished execution. <div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">q</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>
</pre></div>
</div>
</p>
<p>Once the kernel finished execution, we can use an <code class="docutils literal notranslate"><span class="pre">host_accessor</span></code> to access the updated vector <code class="docutils literal notranslate"><span class="pre">v</span></code> on the host. Here we create the accessor by passing <code class="docutils literal notranslate"><span class="pre">read_only</span></code> as we only need to read the values of the vector. <div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">host_accessor</span><span class="w"> </span><span class="n">acc</span><span class="p">{</span><span class="n">buf_v</span><span class="p">,</span><span class="w"> </span><span class="n">read_only</span><span class="p">};</span>
</pre></div>
</div>
</p>
</dd></div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="device-discovery.html" class="btn btn-neutral float-left" title="Device discovery example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="vector-init-refactored.html" class="btn btn-neutral float-right" title="Vector initialization example #2" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, sycl-examples.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>